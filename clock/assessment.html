<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clock</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1e3c72, #2a5298);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: 1px solid rgba(255, 255, 255, 0.18);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --text-color: white;
            --accent-color: #4CAF50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            height: 100vh;
            width: 100vw;
            display: flex;
            background: var(--primary-gradient);
            color: var(--text-color);
            overflow: hidden;
            /* Prevent scrolling */
        }

        /* Layout Container */
        .main-layout {
            display: flex;
            width: 100%;
            height: 100%;
            padding: 1rem;
            gap: 1rem;
        }

        /* Left Column: Logo */
        .left-column {
            flex: 0.5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: var(--glass-bg);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            padding: 1rem;
            max-width: 25%;
            gap: 1rem;
        }

        .logo-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2));
        }

        /* Right Column: Controls & Timer */
        .right-column {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: var(--glass-bg);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            padding: 1.5rem;
            overflow-y: auto;
            /* Allow internal scrolling if absolutely needed on small screens */
        }

        /* Header Section */
        .header-section {
            text-align: center;
            flex-shrink: 0;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subject-title-input {
            width: 100%;
            padding: 0.5rem;
            font-size: 2.4rem;
            /* Doubled from 1.2rem */
            text-align: center;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 8px;
            color: white;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            margin-bottom: 10rem;
            /* Added padding below */
        }

        .subject-title-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            border-bottom: 2px solid var(--accent-color);
        }

        .subject-title-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Timer Section */
        .timer-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px;
        }

        .timer-display {
            font-size: clamp(8rem, 20vw, 16rem);
            /* Doubled font size */
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
            letter-spacing: 5px;
            line-height: 1;
        }

        .set-time-display {
            font-size: 1.5rem;
            color: var(--accent-color);
            margin-top: 0.5rem;
        }

        /* Controls Section */
        .controls-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex-shrink: 0;
        }

        .time-inputs {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }

        .time-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
        }

        .time-input-group label {
            font-size: 0.8rem;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .time-input-controls {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.3rem;
            border-radius: 8px;
        }

        .time-input-controls button {
            width: 50px;
            /* Doubled */
            height: 50px;
            /* Doubled */
            padding: 0;
            font-size: 2rem;
            /* Doubled */
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .time-input-controls input {
            width: 80px;
            /* Doubled */
            padding: 0.4rem;
            /* Doubled */
            font-size: 2rem;
            /* Doubled */
            background: transparent;
            color: white;
            text-align: center;
            border: none;
        }

        .main-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        button {
            padding: 1.2rem 2.4rem;
            /* Doubled padding */
            font-size: 1.8rem;
            /* Doubled font size */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--accent-color);
            color: white;
            transition: transform 0.2s, background-color 0.2s;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.4);
            cursor: not-allowed;
            transform: none;
        }

        button#reset,
        button#stopEndExam,
        button#stopTts {
            background-color: #ff4444;
        }

        button#pause,
        button#pauseEndExam,
        button#pauseTts {
            background-color: #ffbb33;
            color: black;
        }

        button#playTts,
        button#playEndExam {
            background-color: #33b5e5;
        }

        /* TTS Section - Compact */
        .tts-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 0.8rem;
            margin-top: auto;
            /* Push to bottom if space allows */
        }

        .tts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 0.5rem;
        }

        .tts-header h3 {
            font-size: 1rem;
            margin: 0;
        }

        .tts-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            padding: 0.2rem 0.5rem;
            cursor: pointer;
            min-width: auto;
        }

        .tts-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .tts-container.minimized .tts-content {
            display: none;
        }

        .tts-container textarea {
            width: 100%;
            height: 180px;
            /* Reduced for better fit at normal zoom levels */
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 5px;
            padding: 0.5rem;
            resize: vertical;
            font-size: 0.9rem;
            color: #333;
        }

        .tts-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tts-settings {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex: 1;
        }

        .tts-settings select {
            flex: 1;
            padding: 0.3rem;
            border-radius: 4px;
            border: none;
            font-size: 0.8rem;
            max-width: 200px;
        }

        .tts-playback-controls {
            display: flex;
            gap: 0.3rem;
        }

        .tts-playback-controls button {
            padding: 1.2rem 2.4rem;
            /* Doubled to match main buttons */
            font-size: 1.8rem;
            /* Doubled to match main buttons */
            min-width: auto;
        }

        /* End Exam Controls */
        .end-exam-controls {
            background: rgba(255, 68, 68, 0.2);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin-top: 1rem;
            display: none;
            animation: slideUp 0.3s ease;
        }

        .end-exam-controls.show {
            display: block;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Announcement Overlay */
        .announcement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 2rem;
            border-radius: 15px;
            z-index: 1000;
            text-align: center;
            font-size: 1.5rem;
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .warning {
            color: #ff4444;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        /* Responsive Design */
        @media (max-width: 1600px) {
            .timer-display {
                font-size: clamp(6rem, 15vw, 12rem);
            }

            .time-input-controls button {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
            }

            .time-input-controls input {
                width: 60px;
                font-size: 1.5rem;
            }

            button {
                padding: 1rem 2rem;
                font-size: 1.5rem;
            }

            .tts-playback-controls button {
                padding: 1rem 2rem;
                font-size: 1.5rem;
            }
        }

        @media (max-width: 1400px) {
            h1 {
                font-size: 1.5rem;
            }

            .timer-display {
                font-size: clamp(5rem, 12vw, 10rem);
            }

            .subject-title-input {
                font-size: 2rem;
            }

            .time-input-controls button {
                width: 35px;
                height: 35px;
                font-size: 1.2rem;
            }

            .time-input-controls input {
                width: 50px;
                font-size: 1.2rem;
            }

            button {
                padding: 0.8rem 1.6rem;
                font-size: 1.2rem;
            }

            .tts-playback-controls button {
                padding: 0.8rem 1.6rem;
                font-size: 1.2rem;
            }

            .tts-container textarea {
                height: 180px;
            }
        }

        @media (max-width: 1200px) {
            .main-layout {
                flex-direction: column;
                overflow-y: auto;
            }

            .left-column {
                max-width: 100%;
                flex: 0 0 auto;
                padding: 1rem;
            }

            .right-column {
                flex: 1;
                overflow: visible;
            }

            .timer-display {
                font-size: clamp(4rem, 10vw, 8rem);
            }

            .subject-title-input {
                font-size: 1.5rem;
            }

            .time-input-controls button {
                width: 30px;
                height: 30px;
                font-size: 1rem;
            }

            .time-input-controls input {
                width: 45px;
                font-size: 1rem;
            }

            button {
                padding: 0.6rem 1.2rem;
                font-size: 1rem;
            }

            .tts-playback-controls button {
                padding: 0.6rem 1.2rem;
                font-size: 1rem;
            }

            .tts-container textarea {
                height: 120px;
            }
        }

        @media (max-width: 768px) {
            .time-inputs {
                gap: 0.5rem;
            }

            h1 {
                font-size: 1.2rem;
            }

            .timer-display {
                font-size: 15vw;
            }

            .subject-title-input {
                font-size: 1.2rem;
            }

            .main-buttons button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .tts-playback-controls button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .tts-controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .tts-container textarea {
                height: 80px;
            }
        }

        @media (max-width: 600px) {
            .time-input-controls button {
                width: 25px;
                height: 25px;
                font-size: 0.9rem;
            }

            .time-input-controls input {
                width: 35px;
                font-size: 0.9rem;
            }

            button {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }

            .tts-playback-controls button {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        /* Hidden elements that might be needed for JS but not shown */
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="main-layout">
        <!-- Left Column: Logo -->
        <div class="left-column">
            <div class="logo-container">
                <img src="YCI LOGO.png" alt="YCI Logo" class="logo">
            </div>
            <div style="width: 100%; display: flex; justify-content: center; margin-top: 1rem;">
                <img src="no_electdevices.jpg" alt="No Electronic Devices"
                    style="max-width: 80%; height: auto; border-radius: 10px;">
            </div>
            <div class="subject-title-container">
                <input type="text" id="subjectTitle" class="subject-title-input" placeholder="Enter Assessment Subject"
                    maxlength="100">
            </div>
        </div>

        <!-- Right Column: Controls & Timer -->
        <div class="right-column">
            <!-- Header -->
            <div class="header-section">
                <h1>Assessment Clock</h1>
            </div>

            <!-- Timer -->
            <div class="timer-section">
                <div class="set-time-display" id="setTimeDisplay" style="display: none;">Ready to start: 00:00:00</div>
                <div class="timer-display" id="timer">00:00:00</div>

                <div class="end-exam-controls" id="endExamControls">
                    <h3>End of Assessment Announcement</h3>
                    <div>
                        <button id="playEndExam">Play</button>
                        <button id="pauseEndExam">Pause</button>
                        <button id="stopEndExam">Stop</button>
                    </div>
                    <div id="endExamStatus" class="audio-status"></div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-section">
                <div class="time-inputs">
                    <div class="time-input-group">
                        <label>Hours</label>
                        <div class="time-input-controls">
                            <button id="addHour">+</button>
                            <input type="number" id="hours" min="0" max="23" placeholder="HH">
                            <button id="subtractHour">âˆ’</button>
                        </div>
                    </div>
                    <div class="time-input-group">
                        <label>Minutes</label>
                        <div class="time-input-controls">
                            <button id="addMinute">+</button>
                            <input type="number" id="minutes" min="0" max="59" placeholder="MM">
                            <button id="subtractMinute">âˆ’</button>
                        </div>
                    </div>
                    <div class="time-input-group">
                        <label>Seconds</label>
                        <div class="time-input-controls">
                            <button id="addSecond">+</button>
                            <input type="number" id="seconds" min="0" max="59" placeholder="SS">
                            <button id="subtractSecond">âˆ’</button>
                        </div>
                    </div>
                </div>

                <div class="main-buttons">
                    <button id="setTimer">Set</button>
                    <button id="start">Start Assessment</button>
                    <button id="pause">Pause</button>
                    <button id="reset">Reset</button>
                </div>
            </div>

            <!-- TTS Section -->
            <div class="tts-container" id="ttsContainer">
                <div class="tts-header" id="ttsHeader">
                    <h3>Assessment Rules</h3>
                    <button class="tts-toggle" id="ttsToggle">âˆ’</button>
                </div>
                <div class="tts-content" id="ttsContent">
                    <textarea id="ttsText" placeholder="Enter Assessment rules to be read aloud...">You are here to take:
                    Name of assessment: MATHEMATICS;
                    Syllabus code: 0580;
                    
                    Do not open the question paper until I instruct you to do so. You are now under exam conditions and must follow the rules detailed on the â€˜Notice to Candidatesâ€™ posters you can see in the room. You must not communicate with, ask for help from, or give help to any other candidate in the exam room. If you have a question at any time you must raise your hand and wait until an invigilator comes to you. Invigilators cannot answer any questions about the content of the question paper.
 
                    You are not allowed to have any unauthorised items in the exam room. If you have any unauthorised items, including mobile phones or any kind of electronic device you must hand them in now. If you do not hand them in your results may be cancelled.

                    No communication devices should be brought into the venue but if this is unavoidable, you must turn them off (including the alarm function) and put them under the chair in a position clearly visible to the invigilators.  If an electronic or communication device (e.g. PDA, mobile phones, tablets, MP3 players, electronic dictionaries, databank watches, smartwatches, Bluetooth headsets, pagers, etc.), is found in your pocket or on your body, you will be disqualified for the paper being examined.  If the electronic or communication device placed under the chair is found switched on or sounded during the Assessment, you may receive mark penalties.  Please note that the Campus cannot be held responsible for the security of these items in the Assessment venue.  Such devices must not be taken away should you go to lavatory during the Assessment.  However, you may request the invigilator to keep them temporarily. 
                    
                    You must put all your personal belongings including all electronic or communication devices (For example PDA, mobile phones, tablets, MP3 players, electronic dictionary, data bank watches, smartwatches, Bluetooth headsets, pagers, etc) in small bags that can be properly closed with a zip or buckle.  All the bags, books including electronic or communication devices and all unauthorized materials must be placed under the chair in a position clearly visible to the invigilator.  Check to ensure you do not have in your possession, or on your desk, any material relating to the Assessment.  If you are subsequently found to be in possession of such materials you will be considered to be cheating. You may not leave the venue during the first 30 minutes and during the final 15 minutes of the Assessment.

                    If during the Assessment you are suspected of cheating, the front cover of your answer book will be signed by the Invigilator to indicate that suspected cheating occurred.  Any unauthorised material will be taken from you and you will subsequently be required to present yourself to a Disciplinary Hearing. 

                    Place your Student ID card or Hong Kong ID card on the top right corner of the desk so that we can check them.

                    Do not turn the page of the question paper until you are told to do so. 

                    You must not communicate with any other student, nor do anything to cause a distraction.  Any misconduct will be reported and action taken. 

                    Eating and drinking is not allowed in the venue.  If you need to drink water (to accompany medication for example) or have any other urgent needs, raise your hand to attract an Invigilator's attention. 

                    You may not leave the venue during the first 30 minutes and during the final 15 minutes of the Assessment. 

                    We will announce the time remaining at the 30 minutes, 15 minutes and 5 minutes before the end of the Assessment. 

                    You are now under Assessment conditions.  Please do not write anything until you are told to do so. 

                    Please remain seated quietly.
                    </textarea>

                    <div class="tts-controls-row">
                        <div class="tts-settings">
                            <label for="ttsVoice">Voice:</label>
                            <select id="ttsVoice"></select>

                            <!-- Hidden but kept for JS compatibility if needed, or we can remove if JS doesn't strictly need them visible -->
                            <div class="hidden">
                                <input type="range" id="ttsRate" min="0.5" max="2" step="0.1" value="1">
                                <span id="ttsRateValue">1.0</span>
                                <input type="range" id="ttsPitch" min="0.5" max="2" step="0.1" value="1">
                                <span id="ttsPitchValue">1.0</span>
                                <input type="text" id="presetName">
                                <button id="savePreset">Save</button>
                                <select id="presetSelect"></select>
                                <button id="loadPreset">Load</button>
                                <button id="deletePreset">Delete</button>
                            </div>
                        </div>

                        <div class="tts-playback-controls">
                            <button id="playTts">Speak</button>
                            <button id="pauseTts">Pause</button>
                            <button id="resumeTts">Resume</button>
                            <button id="stopTts">Stop</button>
                        </div>
                    </div>
                    <div id="ttsStatus" class="audio-status" style="font-size: 0.8rem; margin-top: 0.2rem;"></div>
                </div>
            </div>

            <!-- Assessment Completed TTS Section -->
            <div class="tts-container" id="ttsCompletedContainer">
                <div class="tts-header" id="ttsCompletedHeader">
                    <h3>Assessment Completed</h3>
                    <button class="tts-toggle" id="ttsCompletedToggle">âˆ’</button>
                </div>
                <div class="tts-content" id="ttsCompletedContent">
                    <textarea id="ttsCompletedText"
                        placeholder="Enter message to be read when timer reaches 0...">Time is up, pens down.</textarea>

                    <div class="tts-controls-row" style="display: none;">
                        <!-- Hidden controls -->
                    </div>
                    <div id="ttsCompletedStatus" class="audio-status" style="font-size: 0.8rem; margin-top: 0.2rem;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlays -->
    <div class="announcement" id="announcement">
        Attention! The assessment will begin shortly. Please ensure you have all necessary materials ready.
    </div>

    <audio id="endExamAudio">
        <source src="End of examination.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        let timeLeft;
        let timerId = null;
        let isRunning = false;
        let isPlayingEndExam = false;
        let isEndExamPaused = false;
        let isSpeaking = false;
        let isPausedTts = false;
        let speechUtterance = null;
        let speechSynthesis = window.speechSynthesis;

        const timerDisplay = document.getElementById('timer');
        const startButton = document.getElementById('start');
        const pauseButton = document.getElementById('pause');
        const resetButton = document.getElementById('reset');
        const setTimerButton = document.getElementById('setTimer');
        const setTimeDisplay = document.getElementById('setTimeDisplay');
        const hoursInput = document.getElementById('hours');
        const minutesInput = document.getElementById('minutes');
        const secondsInput = document.getElementById('seconds');
        const endExamAudio = document.getElementById('endExamAudio');
        const endExamControls = document.getElementById('endExamControls');
        const playEndExamButton = document.getElementById('playEndExam');
        const pauseEndExamButton = document.getElementById('pauseEndExam');
        const stopEndExamButton = document.getElementById('stopEndExam');
        const endExamStatus = document.getElementById('endExamStatus');
        const announcementDiv = document.getElementById('announcement');
        const ttsTextarea = document.getElementById('ttsText');
        const playTtsButton = document.getElementById('playTts');
        const pauseTtsButton = document.getElementById('pauseTts');
        const resumeTtsButton = document.getElementById('resumeTts');
        const stopTtsButton = document.getElementById('stopTts');
        const ttsStatus = document.getElementById('ttsStatus');
        const ttsVoiceSelect = document.getElementById('ttsVoice');
        const ttsRateInput = document.getElementById('ttsRate');
        const ttsPitchInput = document.getElementById('ttsPitch');
        const ttsRateValue = document.getElementById('ttsRateValue');
        const ttsPitchValue = document.getElementById('ttsPitchValue');
        const presetNameInput = document.getElementById('presetName');
        const savePresetButton = document.getElementById('savePreset');
        const presetSelect = document.getElementById('presetSelect');
        const loadPresetButton = document.getElementById('loadPreset');
        const deletePresetButton = document.getElementById('deletePreset');
        const ttsContainer = document.getElementById('ttsContainer');
        const ttsHeader = document.getElementById('ttsHeader');
        const ttsToggle = document.getElementById('ttsToggle');
        const ttsContent = document.getElementById('ttsContent');
        const subjectTitleInput = document.getElementById('subjectTitle');

        // Assessment Completed TTS elements
        const ttsCompletedTextarea = document.getElementById('ttsCompletedText');
        const ttsCompletedStatus = document.getElementById('ttsCompletedStatus');
        const ttsCompletedContainer = document.getElementById('ttsCompletedContainer');
        const ttsCompletedHeader = document.getElementById('ttsCompletedHeader');
        const ttsCompletedToggle = document.getElementById('ttsCompletedToggle');
        const ttsCompletedContent = document.getElementById('ttsCompletedContent');

        let isSpeakingCompleted = false;
        let speechCompletedUtterance = null;

        // Disable buttons initially
        pauseButton.disabled = true;
        startButton.disabled = true;

        function updateDisplay(timeInSeconds) {
            const hours = Math.floor(timeInSeconds / 3600);
            const minutes = Math.floor((timeInSeconds % 3600) / 60);
            const seconds = timeInSeconds % 60;

            timerDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            if (timeInSeconds <= 10) {
                timerDisplay.classList.add('warning');
            } else {
                timerDisplay.classList.remove('warning');
            }
        }

        function setTimer() {
            const hours = parseInt(hoursInput.value) || 0;
            const minutes = parseInt(minutesInput.value) || 0;
            const seconds = parseInt(secondsInput.value) || 0;

            if (hours === 0 && minutes === 0 && seconds === 0) {
                alert('Please set a time duration!');
                return;
            }

            timeLeft = hours * 3600 + minutes * 60 + seconds;
            updateDisplay(timeLeft);

            // Show the set time display
            setTimeDisplay.style.display = 'block';
            setTimeDisplay.textContent = `Ready to start: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Enable start button
            startButton.disabled = false;
        }

        async function startTimer() {
            if (timerId !== null) return;

            // If time is not set, set it first
            if (timeLeft === undefined || timeLeft === 0) {
                setTimer();
                if (timeLeft === 0) return; // Setting failed
            }

            // Disable inputs and buttons during timer
            hoursInput.disabled = true;
            minutesInput.disabled = true;
            secondsInput.disabled = true;
            startButton.disabled = true;
            pauseButton.disabled = true;
            resetButton.disabled = true;
            setTimerButton.disabled = true;

            // Hide the set time display
            setTimeDisplay.style.display = 'none';

            // Re-enable pause and reset buttons
            pauseButton.disabled = false;
            resetButton.disabled = false;

            isRunning = true;

            timerId = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateDisplay(timeLeft);
                } else {
                    clearInterval(timerId);
                    timerId = null;
                    // Speak the completion message
                    playCompletedTtsAuto();
                    // Show end exam controls and play audio
                    endExamControls.classList.add('show');
                    playEndExamAudio();
                    // alert('Exam time is up!'); // Removed to prevent blocking TTS
                    resetTimer();
                }
            }, 1000);
        }

        function pauseTimer() {
            if (timerId !== null) {
                clearInterval(timerId);
                timerId = null;
                startButton.disabled = false;
                isRunning = false;
            }
        }

        function resetTimer() {
            clearInterval(timerId);
            timerId = null;
            isRunning = false;
            timeLeft = 0;
            updateDisplay(0);

            // Enable inputs and buttons
            hoursInput.disabled = false;
            minutesInput.disabled = false;
            secondsInput.disabled = false;
            startButton.disabled = true;
            setTimerButton.disabled = false;

            // Clear inputs
            hoursInput.value = '';
            minutesInput.value = '';
            secondsInput.value = '';

            // Hide the set time display
            setTimeDisplay.style.display = 'none';

            timerDisplay.classList.remove('warning');
            endExamControls.classList.remove('show');
            stopEndExamAudio();
        }

        function playEndExamAudio() {
            if (isPlayingEndExam && !isEndExamPaused) return;

            if (isEndExamPaused) {
                // Resume playback
                endExamAudio.play().catch(error => {
                    console.log('Audio playback failed:', error);
                    endExamStatus.textContent = "Error playing audio file.";
                    resetEndExamState();
                });
                isEndExamPaused = false;
                endExamStatus.textContent = "Playing end of Assessment announcement...";
            } else {
                // Start new playback
                isPlayingEndExam = true;
                endExamAudio.currentTime = 0;
                endExamAudio.play().catch(error => {
                    console.log('Audio playback failed:', error);
                    endExamStatus.textContent = "Error playing audio file.";
                    resetEndExamState();
                });
                endExamStatus.textContent = "Playing end of Assessment announcement...";
            }

            // Update button states
            playEndExamButton.disabled = true;
            pauseEndExamButton.disabled = false;
            stopEndExamButton.disabled = false;
        }

        function pauseEndExamAudio() {
            if (!isPlayingEndExam || isEndExamPaused) return;

            endExamAudio.pause();
            isEndExamPaused = true;
            playEndExamButton.disabled = false;
            endExamStatus.textContent = "Announcement paused. Click Play to resume.";
        }

        function stopEndExamAudio() {
            endExamAudio.pause();
            endExamAudio.currentTime = 0;
            resetEndExamState();
            endExamStatus.textContent = "Announcement stopped.";
            setTimeout(() => {
                endExamStatus.textContent = "";
                endExamControls.classList.remove('show');
            }, 3000);
        }

        function resetEndExamState() {
            isPlayingEndExam = false;
            isEndExamPaused = false;
            playEndExamButton.disabled = false;
            pauseEndExamButton.disabled = true;
            stopEndExamButton.disabled = true;
        }

        // End exam audio completion handler
        endExamAudio.addEventListener('ended', () => {
            resetEndExamState();
            endExamStatus.textContent = "End of Assessment announcement completed.";
            setTimeout(() => {
                endExamStatus.textContent = "";
                endExamControls.classList.remove('show');
            }, 3000);
        });

        // Initialize button states
        pauseEndExamButton.disabled = true;
        stopEndExamButton.disabled = true;
        pauseTtsButton.disabled = true;
        resumeTtsButton.disabled = true;
        stopTtsButton.disabled = true;

        // Add event listeners for audio control buttons
        playEndExamButton.addEventListener('click', playEndExamAudio);
        pauseEndExamButton.addEventListener('click', pauseEndExamAudio);
        stopEndExamButton.addEventListener('click', stopEndExamAudio);

        // Add event listeners for TTS control buttons
        playTtsButton.addEventListener('click', playTts);
        pauseTtsButton.addEventListener('click', pauseTts);
        resumeTtsButton.addEventListener('click', resumeTts);
        stopTtsButton.addEventListener('click', stopTts);

        // Add event listeners for preset buttons
        savePresetButton.addEventListener('click', savePreset);
        loadPresetButton.addEventListener('click', loadPreset);
        deletePresetButton.addEventListener('click', deletePreset);

        // Initialize preset dropdown
        updatePresetDropdown();

        // Text-to-Speech functions
        function playTts() {
            const text = ttsTextarea.value.trim();
            if (!text) {
                alert('Please enter text to be read aloud.');
                return;
            }

            if (isSpeaking && !isPausedTts) return;

            if (isPausedTts) {
                // Resume speech
                speechSynthesis.resume();
                isPausedTts = false;
                ttsStatus.textContent = "Speaking...";
                playTtsButton.disabled = true;
                resumeTtsButton.disabled = true;
                pauseTtsButton.disabled = false;
            } else {
                // Start new speech
                speechUtterance = new SpeechSynthesisUtterance(text);

                // Set voice to selected voice
                const selectedVoiceName = ttsVoiceSelect.value;
                const voices = speechSynthesis.getVoices();
                const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);

                if (selectedVoice) {
                    speechUtterance.voice = selectedVoice;
                } else {
                    console.warn('Selected voice not found, using default');
                }

                speechUtterance.rate = parseFloat(ttsRateInput.value);
                speechUtterance.pitch = parseFloat(ttsPitchInput.value);

                speechUtterance.onstart = () => {
                    isSpeaking = true;
                    ttsStatus.textContent = "Speaking...";
                    playTtsButton.disabled = true;
                    resumeTtsButton.disabled = true;
                    pauseTtsButton.disabled = false;
                    stopTtsButton.disabled = false;
                };

                speechUtterance.onend = () => {
                    resetTtsState();
                    ttsStatus.textContent = "Finished speaking.";
                    setTimeout(() => {
                        ttsStatus.textContent = "";
                    }, 3000);
                };

                speechUtterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event);
                    ttsStatus.textContent = "Stop button is pressed while speaking.";
                    resetTtsState();
                };

                // Start speaking
                speechSynthesis.speak(speechUtterance);
            }
        }

        function pauseTts() {
            if (!isSpeaking || isPausedTts) return;

            speechSynthesis.pause();
            isPausedTts = true;
            ttsStatus.textContent = "Paused. Click Resume to continue.";
            pauseTtsButton.disabled = true;
            resumeTtsButton.disabled = false;
        }

        function resumeTts() {
            if (!isSpeaking || !isPausedTts) return;

            speechSynthesis.resume();
            isPausedTts = false;
            ttsStatus.textContent = "Speaking...";
            pauseTtsButton.disabled = false;
            resumeTtsButton.disabled = true;
        }

        function stopTts() {
            speechSynthesis.cancel();
            resetTtsState();
            ttsStatus.textContent = "Stopped speaking.";
            setTimeout(() => {
                ttsStatus.textContent = "";
            }, 3000);
        }

        function resetTtsState() {
            isSpeaking = false;
            isPausedTts = false;
            playTtsButton.disabled = false;
            pauseTtsButton.disabled = true;
            resumeTtsButton.disabled = true;
            stopTtsButton.disabled = true;
        }

        // Assessment Completed TTS functions
        function playCompletedTtsAuto() {
            const text = ttsCompletedTextarea.value.trim();
            if (!text) return;

            speechCompletedUtterance = new SpeechSynthesisUtterance(text);

            // Set voice to selected voice (same as Assessment Rules)
            const selectedVoiceName = ttsVoiceSelect.value;
            const voices = speechSynthesis.getVoices();
            const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);

            if (selectedVoice) {
                speechCompletedUtterance.voice = selectedVoice;
            }

            speechCompletedUtterance.rate = 1;
            speechCompletedUtterance.pitch = 1;

            speechCompletedUtterance.onstart = () => {
                isSpeakingCompleted = true;
                ttsCompletedStatus.textContent = "Speaking...";
            };

            speechCompletedUtterance.onend = () => {
                resetCompletedTtsState();
                ttsCompletedStatus.textContent = "Finished speaking.";
                setTimeout(() => {
                    ttsCompletedStatus.textContent = "";
                }, 3000);
            };

            speechCompletedUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                ttsCompletedStatus.textContent = "Error occurred while speaking.";
                resetCompletedTtsState();
            };

            // Start speaking
            speechSynthesis.speak(speechCompletedUtterance);
        }

        function resetCompletedTtsState() {
            isSpeakingCompleted = false;
        }

        // TTS preset functions
        function savePreset() {
            const presetName = presetNameInput.value.trim();
            if (!presetName) {
                alert('Please enter a name for this preset.');
                return;
            }

            const presetData = {
                text: ttsTextarea.value,
                rate: ttsRateInput.value,
                pitch: ttsPitchInput.value
                // Voice selection removed as it's fixed
            };

            // Get existing presets or initialize empty object
            const existingPresets = JSON.parse(localStorage.getItem('ttsPresets') || '{}');

            // Add/update preset
            existingPresets[presetName] = presetData;

            // Save back to localStorage
            localStorage.setItem('ttsPresets', JSON.stringify(existingPresets));

            // Update preset dropdown
            updatePresetDropdown();

            // Clear preset name input
            presetNameInput.value = '';

            ttsStatus.textContent = `Preset "${presetName}" saved.`;
            setTimeout(() => {
                ttsStatus.textContent = '';
            }, 3000);
        }

        function loadPreset() {
            const selectedPreset = presetSelect.value;
            if (!selectedPreset) {
                alert('Please select a preset to load.');
                return;
            }

            // Load presets from localStorage
            const presets = JSON.parse(localStorage.getItem('ttsPresets') || '{}');

            if (presets[selectedPreset]) {
                const preset = presets[selectedPreset];

                // Apply preset values
                ttsTextarea.value = preset.text || '';
                ttsRateInput.value = preset.rate || 1;
                ttsPitchInput.value = preset.pitch || 1;

                // Update display values
                ttsRateValue.textContent = parseFloat(ttsRateInput.value).toFixed(1);
                ttsPitchValue.textContent = parseFloat(ttsPitchInput.value).toFixed(1);

                ttsStatus.textContent = `Preset "${selectedPreset}" loaded.`;
                setTimeout(() => {
                    ttsStatus.textContent = '';
                }, 3000);
            } else {
                alert('Preset not found.');
            }
        }

        function deletePreset() {
            const selectedPreset = presetSelect.value;
            if (!selectedPreset) {
                alert('Please select a preset to delete.');
                return;
            }

            // Load presets from localStorage
            const presets = JSON.parse(localStorage.getItem('ttsPresets') || '{}');

            if (presets[selectedPreset]) {
                // Confirm deletion
                if (confirm(`Are you sure you want to delete preset "${selectedPreset}"?`)) {
                    // Delete preset
                    delete presets[selectedPreset];

                    // Save back to localStorage
                    localStorage.setItem('ttsPresets', JSON.stringify(presets));

                    // Update preset dropdown
                    updatePresetDropdown();

                    ttsStatus.textContent = `Preset "${selectedPreset}" deleted.`;
                    setTimeout(() => {
                        ttsStatus.textContent = '';
                    }, 3000);
                }
            } else {
                alert('Preset not found.');
            }
        }

        function updatePresetDropdown() {
            // Clear existing options except the default one
            while (presetSelect.options.length > 1) {
                presetSelect.remove(1);
            }

            // Load presets from localStorage
            const presets = JSON.parse(localStorage.getItem('ttsPresets') || '{}');

            // Add presets to dropdown
            for (const presetName in presets) {
                const option = document.createElement('option');
                option.value = presetName;
                option.textContent = presetName;
                presetSelect.appendChild(option);
            }
        }

        // Initialize TTS voice options
        function populateVoiceList() {
            const voices = speechSynthesis.getVoices();
            ttsVoiceSelect.innerHTML = '';

            // Filter for English and Traditional Chinese voices
            let relevantVoices = voices.filter(voice =>
                voice.lang.startsWith('en') ||
                voice.lang === 'zh-TW' ||
                voice.lang === 'zh-HK'
            );

            // Sort voices: English first, then Chinese; Natural/Online first within each language
            relevantVoices.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                const aIsNatural = aName.includes('natural') || aName.includes('online');
                const bIsNatural = bName.includes('natural') || bName.includes('online');
                const aIsEnglish = a.lang.startsWith('en');
                const bIsEnglish = b.lang.startsWith('en');

                // First, sort by language (English first)
                if (aIsEnglish && !bIsEnglish) return -1;
                if (!aIsEnglish && bIsEnglish) return 1;

                // Within same language group, prioritize Natural/Online
                if (aIsNatural && !bIsNatural) return -1;
                if (!aIsNatural && bIsNatural) return 1;

                // Finally, sort alphabetically by name
                return aName.localeCompare(bName);
            });

            // Add voices to the dropdown
            relevantVoices.forEach(voice => {
                const option = document.createElement('option');
                const isNatural = voice.name.toLowerCase().includes('natural') || voice.name.toLowerCase().includes('online');
                option.textContent = `${isNatural ? 'ðŸŒŸ ' : ''}${voice.name} (${voice.lang})`;
                option.value = voice.name;
                ttsVoiceSelect.appendChild(option);
            });

            // Try to select Microsoft Andrew as default if available, otherwise first available
            const andrewVoice = relevantVoices.find(voice =>
                voice.name.includes('Microsoft Andrew') &&
                voice.name.includes('Natural') &&
                voice.lang === 'en-US'
            );

            if (andrewVoice) {
                ttsVoiceSelect.value = andrewVoice.name;
            }
        }

        // Handle voice list changes
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        // Initial population attempt
        populateVoiceList();

        // Update rate and pitch display values
        ttsRateInput.addEventListener('input', () => {
            ttsRateValue.textContent = parseFloat(ttsRateInput.value).toFixed(1);
        });

        ttsPitchInput.addEventListener('input', () => {
            ttsPitchValue.textContent = parseFloat(ttsPitchInput.value).toFixed(1);
        });

        // Toggle TTS container minimize/expand
        ttsHeader.addEventListener('click', () => {
            ttsContainer.classList.toggle('minimized');
            ttsToggle.textContent = ttsContainer.classList.contains('minimized') ? '+' : 'âˆ’';
        });

        // Toggle Assessment Completed TTS container minimize/expand
        ttsCompletedHeader.addEventListener('click', () => {
            ttsCompletedContainer.classList.toggle('minimized');
            ttsCompletedToggle.textContent = ttsCompletedContainer.classList.contains('minimized') ? '+' : 'âˆ’';
        });

        startButton.addEventListener('click', startTimer);
        pauseButton.addEventListener('click', pauseTimer);
        resetButton.addEventListener('click', resetTimer);
        setTimerButton.addEventListener('click', setTimer);

        // Input validation
        function validateInput(input, max) {
            input.addEventListener('input', () => {
                let value = parseInt(input.value);
                if (isNaN(value)) {
                    input.value = '';
                } else if (value < 0) {
                    input.value = '0';
                } else if (value > max) {
                    input.value = max;
                }
            });
        }

        validateInput(hoursInput, 23);
        validateInput(minutesInput, 59);
        validateInput(secondsInput, 59);

        // Add event listeners for time adjustment buttons
        document.getElementById('addHour').addEventListener('click', () => adjustTime('hours', 1));
        document.getElementById('subtractHour').addEventListener('click', () => adjustTime('hours', -1));
        document.getElementById('addMinute').addEventListener('click', () => adjustTime('minutes', 1));
        document.getElementById('subtractMinute').addEventListener('click', () => adjustTime('minutes', -1));
        document.getElementById('addSecond').addEventListener('click', () => adjustTime('seconds', 1));
        document.getElementById('subtractSecond').addEventListener('click', () => adjustTime('seconds', -1));

        function adjustTime(unit, amount) {
            const input = document.getElementById(unit);
            let value = parseInt(input.value) || 0;
            const max = unit === 'hours' ? 23 : 59;

            value += amount;

            // Handle overflow/underflow
            if (value > max) {
                if (unit === 'minutes') {
                    const hoursInput = document.getElementById('hours');
                    const hours = parseInt(hoursInput.value) || 0;
                    hoursInput.value = hours + 1;
                    value = 0;
                } else if (unit === 'seconds') {
                    const minutesInput = document.getElementById('minutes');
                    const minutes = parseInt(minutesInput.value) || 0;
                    minutesInput.value = minutes + 1;
                    value = 0;
                } else {
                    value = max;
                }
            } else if (value < 0) {
                if (unit === 'minutes') {
                    const hoursInput = document.getElementById('hours');
                    const hours = parseInt(hoursInput.value) || 0;
                    if (hours > 0) {
                        hoursInput.value = hours - 1;
                        value = 59;
                    } else {
                        value = 0;
                    }
                } else if (unit === 'seconds') {
                    const minutesInput = document.getElementById('minutes');
                    const minutes = parseInt(minutesInput.value) || 0;
                    if (minutes > 0) {
                        minutesInput.value = minutes - 1;
                        value = 59;
                    } else {
                        value = 0;
                    }
                } else {
                    value = 0;
                }
            }

            input.value = value;
        }

    </script>
</body>

</html>
